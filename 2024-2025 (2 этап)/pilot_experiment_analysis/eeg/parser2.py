# -*- coding: utf-8 -*-
"""parser2.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1m5vHjQwzSvzDedIzY4_1POp5eIZLOCwo
"""

import pandas as pd
import os

mean_durations = []
fixation_counts = []
directory = 'FixationList' # Относительный путь к папке с fix листами
files = os.listdir(directory)

val_path = 'Val_ver.xlsx' # Относительный путь к файлу с разметкой
val_ver_df = pd.read_csv(val_path, sep=';')

for file in files:
    fix_df = pd.read_csv(os.path.join(directory, file))
    fix_df['RowNumber'] = fix_df['RowNumber'].str.replace('Main', '').astype(int)

    # Объединение val и fixation
    merged_df = pd.merge(fix_df, val_ver_df, left_on='RowNumber', right_on='Row_num')

    agg_df = merged_df.groupby(['Name', 'RowNumber', 'Valence', 'Veracity'])['Duration'].agg(['mean', 'count']).reset_index()
    agg_df.rename(columns={'mean': 'Mean_Duration', 'count': 'Fixation_Count'}, inplace=True)

    # Приведение столбцов к int
    agg_df['Valence'] = agg_df['Valence'].astype(int)
    agg_df['Veracity'] = agg_df['Veracity'].astype(int)

    # Создание столбца для итогового df
    agg_df['ID'] = 'rn' + agg_df['RowNumber'].astype(str) + '_val' + agg_df['Valence'].astype(str) + '_ver' + agg_df['Veracity'].astype(str)

    agg_df['RowNumber'] = pd.to_numeric(agg_df['RowNumber'], errors='coerce')
    agg_df.sort_values(by=['RowNumber', 'Valence', 'Veracity'], inplace=True)

    # Формирование файлов для статистики продолжительности фиксаций и количества фиксаций
    mean_duration_df = agg_df.pivot(index='Name', columns='ID', values='Mean_Duration')
    fixation_count_df = agg_df.pivot(index='Name', columns='ID', values='Fixation_Count')

    # Добавление данных по текущему участнику в список
    mean_durations.append(mean_duration_df)
    fixation_counts.append(fixation_count_df)
import re
def extract_xyz(column_name):
    return [int(num) for num in re.findall(r'\d+', column_name)]
# Объединение DataFrame по индексу (имени участника)
mean_duration_combined = pd.concat(mean_durations)
fixation_count_combined = pd.concat(fixation_counts)

mean_duration_combined_sorted = mean_duration_combined[sorted(mean_duration_combined.columns, key=extract_xyz)] # Сортировка колонок
fixation_count_combined_sorted = fixation_count_combined[sorted(fixation_count_combined.columns, key=extract_xyz)]

print(mean_duration_combined_sorted.head())
mean_duration_combined_sorted.to_excel('mean_duration_statistics.xlsx')
fixation_count_combined_sorted.to_excel('fixation_count_statistics.xlsx')